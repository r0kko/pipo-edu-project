name: CI

on:
  push:
    branches: ["master", "main"]
    tags:
      - "*"
  pull_request:

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  go_unit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25.7"

      - name: Install sqlc
        run: go install github.com/sqlc-dev/sqlc/cmd/sqlc@v1.25.0

      - name: Generate sqlc
        run: sqlc generate

      - name: Ensure sqlc output committed
        run: git diff --exit-code

      - name: Service unit tests
        run: go test ./internal/service -run 'TestServiceUnit|TestValidate' -coverprofile=service_unit.out

      - name: HTTP unit tests
        run: go test ./internal/http -coverprofile=http_unit.out

      - name: Upload unit coverage
        uses: actions/upload-artifact@v4
        with:
          name: unit-coverage
          path: |
            service_unit.out
            http_unit.out

  go_integration:
    runs-on: ubuntu-latest
    needs: [go_unit]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25.7"

      - name: Integration tests (json)
        shell: bash
        run: |
          set -euo pipefail
          go test -tags=integration -json ./internal/service ./internal/http | tee go-integration.json
          if grep -q '"Action":"skip"' go-integration.json; then
            echo "Integration suite contains skipped tests"
            exit 1
          fi

      - name: Integration coverage (HTTP)
        run: go test -tags=integration ./internal/http -coverprofile=http_integration.out

      - name: Upload integration coverage
        uses: actions/upload-artifact@v4
        with:
          name: integration-coverage
          path: |
            go-integration.json
            http_integration.out

  coverage_gate:
    runs-on: ubuntu-latest
    needs: [go_unit, go_integration]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25.7"

      - name: Download unit coverage
        uses: actions/download-artifact@v4
        with:
          name: unit-coverage
          path: coverage

      - name: Download integration coverage
        uses: actions/download-artifact@v4
        with:
          name: integration-coverage
          path: coverage

      - name: Evaluate coverage thresholds
        shell: bash
        run: |
          set -euo pipefail

          service_cov=$(go tool cover -func=coverage/service_unit.out | awk '/^total:/ {print substr($3, 1, length($3)-1)}')
          http_unit_cov=$(go tool cover -func=coverage/http_unit.out | awk '/^total:/ {print substr($3, 1, length($3)-1)}')
          http_int_cov=$(go tool cover -func=coverage/http_integration.out | awk '/^total:/ {print substr($3, 1, length($3)-1)}')

          echo "service unit coverage: ${service_cov}%"
          echo "http unit coverage: ${http_unit_cov}%"
          echo "http integration coverage: ${http_int_cov}%"

          awk -v v="$service_cov" 'BEGIN { if (v < 85.0) { print "service unit coverage below 85%"; exit 1 } }'
          awk -v i="$http_int_cov" 'BEGIN { if (i < 80.0) { print "http combined (unit+integration) coverage below 80%"; exit 1 } }'

  frontend_verify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Frontend install
        run: npm --prefix frontend ci

      - name: Frontend lint
        run: npm --prefix frontend run lint

      - name: Frontend build
        run: npm --prefix frontend run build

  pr_backend_image_build:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    needs: [coverage_gate, frontend_verify]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build backend image (PR check)
        run: docker build --pull -t "pipo-backend:pr-${GITHUB_SHA}" -f Dockerfile .

  package_runtime_artifact:
    runs-on: ubuntu-latest
    needs: [coverage_gate, frontend_verify]
    if: github.event_name == 'push' && (github.ref_name == 'main' || startsWith(github.ref, 'refs/tags/'))
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build backend image
        run: docker build --pull -t "pipo-backend:${GITHUB_SHA}" -f Dockerfile .

      - name: Smoke test backend container
        shell: bash
        run: |
          set -euo pipefail
          NETWORK="pipo-smoke-net"
          DB_CONTAINER="pipo-smoke-db"
          APP_CONTAINER="pipo-smoke-backend"

          docker network create "${NETWORK}"
          docker run -d --name "${DB_CONTAINER}" --network "${NETWORK}" \
            -e POSTGRES_USER=postgres \
            -e POSTGRES_PASSWORD=postgres \
            -e POSTGRES_DB=pipo \
            postgres:16-alpine

          for i in {1..60}; do
            if docker exec "${DB_CONTAINER}" pg_isready -U postgres -d pipo >/dev/null 2>&1; then
              break
            fi
            if [[ "${i}" == "60" ]]; then
              echo "Postgres is not ready in time"
              docker logs "${DB_CONTAINER}" || true
              exit 1
            fi
            sleep 1
          done

          docker run -d --name "${APP_CONTAINER}" --network "${NETWORK}" -p 18080:8080 \
            -e APP_ENV=dev \
            -e HTTP_ADDR=:8080 \
            -e DB_DSN="postgres://postgres:postgres@${DB_CONTAINER}:5432/pipo?sslmode=disable" \
            -e JWT_SECRET=ci-access-secret \
            -e JWT_REFRESH_SECRET=ci-refresh-secret \
            -e MIGRATE_ON_START=true \
            -e CORS_ORIGINS=http://localhost:5173 \
            "pipo-backend:${GITHUB_SHA}"

          for i in {1..60}; do
            if curl --silent --show-error --fail http://127.0.0.1:18080/health >/dev/null; then
              break
            fi
            if [[ "${i}" == "60" ]]; then
              echo "Backend healthcheck failed"
              docker logs "${APP_CONTAINER}" || true
              docker logs "${DB_CONTAINER}" || true
              exit 1
            fi
            sleep 1
          done

      - name: Package backend image artifact
        run: |
          set -euo pipefail
          docker save "pipo-backend:${GITHUB_SHA}" | gzip > "pipo-backend-image-${GITHUB_SHA}.tar.gz"
          sha256sum "pipo-backend-image-${GITHUB_SHA}.tar.gz" > "pipo-backend-image-${GITHUB_SHA}.sha256"

      - name: Upload backend artifact for main
        if: github.ref_name == 'main'
        uses: actions/upload-artifact@v4
        with:
          name: pipo-backend-image-${{ github.sha }}
          path: |
            pipo-backend-image-${{ github.sha }}.tar.gz
            pipo-backend-image-${{ github.sha }}.sha256
          retention-days: 30

      - name: Upload backend artifact for tags
        if: startsWith(github.ref, 'refs/tags/')
        uses: actions/upload-artifact@v4
        with:
          name: pipo-backend-image-${{ github.sha }}
          path: |
            pipo-backend-image-${{ github.sha }}.tar.gz
            pipo-backend-image-${{ github.sha }}.sha256
          retention-days: 90

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish backend image to GHCR
        shell: bash
        run: |
          set -euo pipefail
          OWNER_LOWER="$(echo "${GITHUB_REPOSITORY_OWNER}" | tr '[:upper:]' '[:lower:]')"
          IMAGE_REPO="ghcr.io/${OWNER_LOWER}/pipo-backend"
          docker tag "pipo-backend:${GITHUB_SHA}" "${IMAGE_REPO}:${GITHUB_SHA}"
          docker push "${IMAGE_REPO}:${GITHUB_SHA}"

          if [[ "${GITHUB_REF}" == "refs/heads/main" ]]; then
            docker tag "pipo-backend:${GITHUB_SHA}" "${IMAGE_REPO}:main"
            docker push "${IMAGE_REPO}:main"
          fi

          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            docker tag "pipo-backend:${GITHUB_SHA}" "${IMAGE_REPO}:${GITHUB_REF_NAME}"
            docker push "${IMAGE_REPO}:${GITHUB_REF_NAME}"
          fi

      - name: Cleanup smoke containers
        if: always()
        shell: bash
        run: |
          docker rm -f pipo-smoke-backend >/dev/null 2>&1 || true
          docker rm -f pipo-smoke-db >/dev/null 2>&1 || true
          docker network rm pipo-smoke-net >/dev/null 2>&1 || true
